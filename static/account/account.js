function loadAccount(){debugLog(loggedin);if(loggedin){$("#lin").hide();$("#lout").show();$("#info").show();$("#setMenu").show();getUserSolves();getUserAvator();$("#username").val(name);$("#nickname").val(nickname);$("#said").val(said);$("#contact").val(contact);$("#silver").val(silver)}else{$("#lin").show();$("#lout").hide();$("#info").hide();$("#setMenu").hide();getCaptcha()}return false}var orderid;function getOrderContent(obj){debugLog(obj);orderid=obj.id;debugLog("click1");$.ajax({type:"POST",url:"ajax.php?m=getOrderInfo",data:{"id":orderid,"token":token},dataType:"json",success:function(data){debugLog(data);if(errorCheck(data)){return false}$("#ordcontents").html('<p style="padding-left: 20%;font-size:18px;">商品标题 : '+data[1][0][4]+'</p><p style="padding-left: 20%;font-size:18px;">订单编号：'+data[1][0][3]+'</p><p style="padding-left: 20%;font-size:18px;">发货时间：'+getMyDate(data[1][0][11])+'</p><p style="padding-left: 20%;font-size:18px;">订单内容：<br /><span style="color:#6eff00;">'+data[1][0][6]+"</span>");$("#ordcontent").modal("open")}});return false}function getMakeOrder(obj){debugLog(obj);orderid=obj.id;debugLog("click1");$.ajax({type:"POST",url:"ajax.php?m=getOrderInfo",data:{"id":orderid,"token":token},dataType:"json",success:function(data){if(errorCheck(data)){return false}$("#makeorder").modal("open")}});return false}function getEditOrder(obj){debugLog(obj);orderid=obj.id;debugLog("click1");$.ajax({type:"POST",url:"ajax.php?m=getOrderInfo",data:{"id":orderid,"token":token},dataType:"json",success:function(data){debugLog(data);if(errorCheck(data)){return false}$("#editorders").html('<div style="margin-top: 1%"><span style="margin-left: 15%;color: red;">* </span><span style="font-size: 14px;">姓名：</span><br /><input id="edit_username" style="font-size: 17px;margin-left: 15%;margin-right: 1%;width: 66%" value="'+data[1][0][12]+'" type="text"/><br /><span style="margin-left: 15%;color: red;">* </span><span style="font-size: 14px;">手机号：</span><br /><input id="edit_mobile" style="font-size: 17px;margin-left: 15%;margin-right: 1%;width: 66%" value="'+data[1][0][13]+'"type="text"/><br /><span style="margin-left: 15%;color: red;">* </span><span style="font-size: 14px;">收货地址：</span><br /><input id="edit_address" style="font-size: 17px;margin-left: 15%;margin-right: 1%;width: 66%" value="'+data[1][0][14]+'" type="text"/><br /><span style="margin-left: 15%;color: red;">* </span><span style="font-size: 14px;">备注：</span><br /><input id="edit_note" style="font-size: 17px;margin-left: 15%;margin-right: 1%;width: 66%" value="'+data[1][0][15]+'" type="text"/><br /><center><button style="margin-right: 8%;width: 16%;border-radius:15px;" class="btn orange accent-4" type="submit">修改并提交</button></center></div>');$("#editorder").modal("open")}});return false}function getOrderList(data){var table=$("<table>");var thead=$("<thead>");$("<th><b>").text("编号").appendTo(thead);$('<th style="width: 17%;"><b>').text("订单号").appendTo(thead);$("<th><b>").text("商品标题").appendTo(thead);$('<th style="text-align: center;"><b>').text("商品缩略图").appendTo(thead);$("<th><b>").text("兑换时间").appendTo(thead);$("<th><b>").text("商品类型").appendTo(thead);$('<th style="text-align: center;"><b>').text("当前状态").appendTo(thead);$('<th style="text-align: center;"><b>').text("操作").appendTo(thead);thead.appendTo(table);debugLog(data[1]);$.each(data[1],function(num,content){var trow=$("<tr>");$("<td>").text(num+1).appendTo(trow);$("<td>").text(content[3]).appendTo(trow);$("<td>").text(content[4]).appendTo(trow);$('<td style="text-align: center;"><img style="width: 50px;height: 50px;border-radius: 50px;" src="'+content[5]+'" />').appendTo(trow);$("<td>").text(getMyDate(content[7])).appendTo(trow);if(content[8]=="1"){$("<td>").text("虚拟商品").appendTo(trow)}else{$("<td>").text("实物商品").appendTo(trow)}if(content[9]=="1"){$('<td style="color:#00ffff;text-align: center;">').html("待发货").appendTo(trow);$('<td style="text-align: center;">').html('<a class="btn orange accent-4" style="border-radius:12px;" id="'+content[0]+'" onclick="getEditOrder(this)">修改订单</a>').appendTo(trow)}else{if(content[9]=="2"){$('<td style="color:#6eff00;text-align: center;">').html("已发货").appendTo(trow);$('<td style="text-align: center;">').html('<a class="btn orange accent-4" style="border-radius:12px;" id="'+content[0]+'" onclick="getOrderContent(this)">查看订单</a>').appendTo(trow)}else{$('<td style="color:red;text-align: center;">').html("待确认").appendTo(trow);$('<td style="text-align: center;">').html('<a class="btn orange accent-4" style="border-radius:12px;" id="'+content[0]+'" onclick="getMakeOrder(this)">确认订单</a>').appendTo(trow)}}$("#contents").html(content[6]);trow.appendTo(table)});$("#orderinfo").html(table.html())}function loadOrder(){$.ajax({type:"POST",url:"ajax.php?m=getOrder",dataType:"json",data:{"token":token},success:function(data){debugLog(data);if(errorCheck(data)){return false}if(data[1][0]=="123"){$("#headers").html('<br /><h5 class="center" style="font-size: 22px;">'+data[1][1]+data[0][1]+"</h5>")
    }else{$("#headers").html('<br /><h5 class="center" style="font-size: 22px;">兑换成功后，请及时确认订单并且填写您的收货地址~'+data[0][1]+"</h5><br />");getOrderList(data)}},error:function(data){debugLog(data)}});return false}function getUserSolveNum(data){debugLog("pic1");debugLog(data);$("#pic1").highcharts({credits:{enabled:false},exporting:{enabled:false},colors:["#FFFFFF","#4caf50","#f44336"],chart:{backgroundColor:"rgba(0,0,0,0)",spacing:[0,0,0,0],},title:{text:""},series:[{type:"sunburst",data:data,allowDrillToNode:true,cursor:"pointer",dataLabels:{formatter:function(){var shape=this.point.node.shapeArgs;var innerArcFraction=(shape.end-shape.start)/(2*Math.PI);var perimeter=2*Math.PI*shape.innerR;var innerArcPixels=innerArcFraction*perimeter;if(innerArcPixels>16){return this.point.name}}},levels:[{level:2,colorByPoint:true,dataLabels:{rotationMode:"parallel"}}]}],tooltip:{useHTML:true,padding:10,style:{fontSize:"20px"},borderWidth:2,formatter:function(){debugLog(this.point);if(this.point.id[0]=="0"){return this.point.name+":"+this.point.value}if(this.point.id[0]=="1"){return this.point.nick+"("+(this.point.value*100/(data.length-17)).toFixed(0)+"%)"}if(this.point.id[0]=="2"){return this.point.name+"("+this.point.value+")"}return this.point.name},}})}function getUserSolveType(data){debugLog("pic2");debugLog(data);$("#pic2").highcharts({credits:{enabled:false},exporting:{enabled:false},colors:["#37a2da","#32c5e9","#67e0e3","#9fe6b8","#ffdb5c","#ff9f7f","#fb7293","#e062ae","#e690d1","#e7bcf3","#9d96f5","#8378ea","#96bfff"],legend:{align:"right",verticalAlign:"top",layout:"vertical",floating:true,},chart:{backgroundColor:"rgba(0,0,0,0)",backgroundColor:"rgba(255, 255, 255, 0)",spacing:[0,0,0,0],style:{fontFamily:"Dosis, sans-serif"},},title:{floating:true,style:{fontSize:"40px"},text:"题目类型",},tooltip:{useHTML:true,padding:10,style:{fontSize:"20px"},borderWidth:2,headerFormat:"<center>{point.key}</center>",pointFormat:"<b>{point.y}</b>({point.percentage:.1f}%)"},plotOptions:{pie:{allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:false},showInLegend:true,point:{events:{mouseOver:function(e){chart.setTitle({text:e.target.name,style:{color:e.target.color}})},mouseOut:function(){setTimeout(function(){chart.setTitle({text:"题目类型",style:{color:"#333333"}})},500)}}},}},series:[{type:"pie",innerSize:"60%",data:data}]},function(c){var centerY=c.series[0].center[1],titleHeight=parseInt(c.title.styles.fontSize);c.setTitle({y:centerY+titleHeight/3,});chart=c})}function getUserSolve(data){var table=$("<table>");var thead=$("<thead>");$("<th><b>").text("No.").appendTo(thead);$("<th><b>").text("Type").appendTo(thead);$("<th><b>").text("Title").appendTo(thead);$("<th><b>").text("Date").appendTo(thead);$("<th><b>").text("IP").appendTo(thead);$("<th><b>").text("Kill").appendTo(thead);thead.appendTo(table);debugLog(data[1]);$.each(data[1],function(num,content){var trow=$("<tr>");$("<td>").text(num+1).appendTo(trow);$("<td>").text(quesType[content[1]]).appendTo(trow);$("<td>").text(content[2]).appendTo(trow);$("<td>").text(getMyDate(content[3])).appendTo(trow);$("<td>").text(content[4]).appendTo(trow);if(content[0]=="1"){$('<td style="color:#4caf50">').text("√").appendTo(trow)}else{$('<td style="color:red">').text("×").appendTo(trow)}trow.appendTo(table)});$("#subinfo").html(table.html())}function getUserSolves(){var allData=[{"id":"0.0","parent":"","name":"总提交数"},{"id":"1.1","parent":"0.0","name":"right","nick":"正确率"},{"id":"1.2","parent":"0.0","name":"error","nick":"错误率"},{"id":"2.1","parent":"1.1","name":"Web"},{"id":"2.2","parent":"1.1","name":"Reverse"},{"id":"2.3","parent":"1.1","name":"Pwn"},{"id":"2.4","parent":"1.1","name":"Misc"},{"id":"2.5","parent":"1.1","name":"Crypto"},{"id":"2.6","parent":"1.1","name":"Stega"},{"id":"2.7","parent":"1.1","name":"Ppc"},{"id":"2.8","parent":"1.2","name":"Web"},{"id":"2.9","parent":"1.2","name":"Reverse"},{"id":"2.10","parent":"1.2","name":"Pwn"},{"id":"2.11","parent":"1.2","name":"Misc"},{"id":"2.12","parent":"1.2","name":"Crypto"},{"id":"2.13","parent":"1.2","name":"Stega"},{"id":"2.14","parent":"1.2","name":"Ppc"}];var correctType=[["Web",0],["Reverse",0],["Pwn",0],["Misc",0],["Crypto",0],["Stega",0],["Ppc",0]];$.ajax({type:"POST",url:"ajax.php?m=getUserSolves",dataType:"json",data:{"token":token},success:function(data){debugLog(data);if(errorCheck(data)){return false}if(data[1].length==0){return false}$.each(data[1],function(n,data){if(data[0]=="1"){allData.push({"id":"3.1","parent":"2."+(parseInt(data[1])+1),"name":data[2],"value":1})}else{allData.push({"id":"3.2","parent":"2."+(parseInt(data[1])+8),"name":data[2],"value":1})}correctType[parseInt(data[1])][1]+=data[0]=="1"?1:0});getUserSolveNum(allData);getUserSolveType(correctType);getUserSolve(data)},error:function(data){debugLog(data)}})}function getUserAvator(){debugLog("getUserAvator");$.ajax({type:"POST",url:"ajax.php?m=getUserAvator",dataType:"json",data:{"token":token},success:function(data){if(errorCheck(data)){return false}$(".headImgShow").attr("src",textToImg(data[1],name))
    },error:function(data){debugLog(data)}});return false}function imgCheck(imgInfo){if(imgInfo===undefined){return true}if(imgInfo.size>204800){Materialize.toast("选择的头像大小过大，请选择小于200k的图片",4000,"rounded");return false}imgName=imgInfo.name;extStart=imgName.lastIndexOf("."),ext=imgName.substring(extStart,imgName.length).toUpperCase();if(ext!==".PNG"&&ext!==".JPG"&&ext!==".JPEG"&&ext!==".GIF"){Materialize.toast("请上传正确格式的图片",4000,"rounded");return false}return true}$(".headImgShow").click(function(){debugLog("触发click");return $(".imgInput").click()});$(".imgInput").change(function(){debugLog("触发change");debugLog($(this)[0].files[0]);$(".headImgShow").attr("src",URL.createObjectURL($(this)[0].files[0]))});$(document).ready(function(){loadAccount();loadOrder();$("input#said, textarea#textarea1,input#nickname").characterCounter();$("#login").submit(function(){if(loggedin){loadAccount();return false}var info=new FormData();info.append("password",$('[name="password"]').prop("value"));info.append("username",$('[name="name"]').prop("value"));info.append("captcha",$('[name="captcha"]').prop("value"));info.append("token",token);$.ajax({type:"POST",url:"ajax.php?m=login",data:info,dataType:"json",processData:false,contentType:false,success:function(data){debugLog(data);if(errorCheck(data)){getCaptcha();return false}loadSession();loadAccount();Materialize.toast(data[0][1],4000,"rounded")},error:function(data){debugLog(data)}});return false});$("#share").click(function(){alert("请手动复制粘贴本网站url (^ v ^) ");return false});$("#userbaseinfo").submit(function(){debugLog("teaminfo click");if(!loggedin){Materialize.toast("你还没有登录!",4000,"rounded");loadAccount();return false}var imgInfo=$(".imgInput")[0].files[0];var imgBase64Data="";debugLog(imgInfo);if(!imgCheck(imgInfo)){return false}var baseAjax=function(imgdata){$.ajax({type:"POST",url:"ajax.php?m=modUserBaseInfo",data:{"img":imgdata,"said":$("#said").val(),"nickname":$("#nickname").val(),"token":token},dataType:"json",success:function(data){debugLog(data);if(errorCheck(data)){return false}Materialize.toast(data[0][1],4000,"rounded");if(data[0][0]=="1"){loadSession();loadAccount()}},error:function(data){debugLog(data)}})};if(imgInfo===undefined){baseAjax("");return false}var reader=new FileReader();var imgUrlBase64=reader.readAsDataURL(imgInfo);reader.onload=function(e){imgBase64Data=reader.result;debugLog("----->");debugLog(imgBase64Data);baseAjax(imgBase64Data)};debugLog("AAAAAAAAAAAAAAAAAAAAAAAA");debugLog(imgBase64Data);return false});$("#makeorders").submit(function(){if(!loggedin){Materialize.toast("你还没有登录!",4000,"rounded");loadAccount();return false}$.ajax({type:"POST",url:"ajax.php?m=getMakeOrders",data:{"username":$("#user_name").val(),"mobile":$("#mobile").val(),"address":$("#address").val(),"note":$("#note").val(),"token":token},dataType:"json",success:function(data){debugLog(data);if(errorCheck(data)){return false}if(data[0][0]=="0"){Materialize.toast(data[0][1],4000,"rounded")}else{Materialize.toast(data[1],4000,"rounded");$("#makeorder").modal("close");loadOrder()}},error:function(data){debugLog(data)}});return false});$("#editorders").submit(function(){if(!loggedin){Materialize.toast("你还没有登录!",4000,"rounded");loadAccount();return false}$.ajax({type:"POST",url:"ajax.php?m=getMakeOrders",data:{"username":$("#edit_username").val(),"mobile":$("#edit_mobile").val(),"address":$("#edit_address").val(),"note":$("#edit_note").val(),"token":token},dataType:"json",success:function(data){debugLog(data);if(errorCheck(data)){return false}if(data[0][0]=="0"){Materialize.toast(data[0][1],4000,"rounded")}else{Materialize.toast(data[1],4000,"rounded");$("#editorder").modal("close");loadOrder()}},error:function(data){debugLog(data)}});return false});$("#passinfo").submit(function(){debugLog("passinfo click");if(!loggedin){Materialize.toast("你还没有登录!",4000,"rounded");loadAccount();return false}$.ajax({type:"POST",url:"ajax.php?m=modUserPass",data:{"old":$("#oldpassword").val(),"new":$("#newpassword1").val(),"repeat":$("#newpassword2").val(),"token":token},dataType:"json",success:function(data){if(errorCheck(data)){return false}Materialize.toast(data[0][1],4000,"rounded");if(data[0][0]=="1"){logout();loadSession();loadAccount()}},error:function(data){debugLog(data)}});return false});$(".makeorder").content({complete:function(){$("#makeorders").html("")}});$(".ordcontent").content({complete:function(){$("#ordcontents").html("")}});$(".editorder").content({complete:function(){$("#editorders").html("")}})});function uploadWp() {
    var files = $('#wp_file')[0].files;
    if(files.length <= 0) {
        Materialize.toast("<span style='color:red;font-weight: bold;'>请选择上传文件！</span>", 4000, "rounded");
        return false;
    }
    var fd = new FormData()
    fd.append('file',files[0]);
    fd.append('token',token);
    $.ajax({
        method:'POST',
        url:'ajax.php?m=uploadWriterUp',
        data:fd,
        // 不对FromData中的url进行编码，原样发送
        processData:false,
        // 不修改contentType属性，使用默认
        contentType:false,
        dataType:"json",
        success: function(data) {
            if (data[0][0] == 0){
                Materialize.toast("<span style='color:red;font-weight: bold;'>"+data[0][1]+"</span>", 4000, "rounded");
            }else if (data[0][0] == 1){
                Materialize.toast(data[0][1], 4000, "rounded");
                if (!document.location.href.endsWith("wp.html")){
                    $("a[href='#wpinfo']").click();
                }else{
                    setTimeout(function () {
                        window.location.reload();
                    },2000);
                }
            }
        }
    })
    return false;
}
$(function(){
    $("a[href='#wpinfo']").click(function () {
        var wp_info_table = $("#wp_info_table");
        $.ajax({
            url: "ajax.php?m=getWriterUp",
            type: "POST",
            dataType:"json",
            data: {"token":token},
            success: function (data) {
                let htmls = `<tr style="font-weight: bold";><td>提交人</td><td>提交时间</td><td>上传WP名称</td></tr>`;
                if (data[1].length == 0){
                    htmls += `<tr><td colspan="3" style="text-align: center">暂无数据</td></tr>`;
                }else{
                    for (let i = 0;i < data[1].length; i++) {
                        if (data[0][0] == 1){
                            htmls+=`<tr><td>${data[1][i][1]}</td><td>${data[1][i][2]}</td><td>${data[1][i][3]}</td></tr>`;
                        }
                    }
                    if (data[1].length == 4){
                        $("#wp_info_aman").css("height",'680px');
                    }else if (data[1].length == 5){
                        $("#wp_info_aman").css("height",'730px');
                    }
                }
                $("#wp_info_table").html(htmls);

            }
        })
    });
    $("button[name='submit_wp']").click(uploadWp);
});